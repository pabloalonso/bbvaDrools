{"designerVersion":"1.4.34","id":"customButtonCNMC","name":"ButtonCNMC","lastUpdate":1524069169095,"template":"<div class=\"text-{{ properties.alignment }}\">\n    <button\n        ng-class=\"'btn btn-' + properties.buttonStyle\"\n        ng-click=\"ctrl.action()\"\n        type=\"button\"\n        ng-disabled=\"properties.disabled || ctrl.busy\" ng-bind-html=\"properties.label | uiTranslate\"></button>\n</div>\n","icon":"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 20'><g><path fill='#CBD5E1' d='M47,15.2c0,0.7-1.7,1.8-1.7,1.8S4.8,17,3.7,17c-1.6,0-3.6-1.9-3.6-1.9s0.7,4.8,4,5c2.4,0.1,42.4,0,42.4,0 s3.5-0.2,3.5-3.6c0-1.3,0.1-11.5,0.1-12.4c-0.1-2-4-4-4-4L47,1.8C47,1.8,47,14.5,47,15.2z'/><path fill='#fff' d='M3.9,1h40.3C45.7,1,47,2.2,47,3.6v10.8c0,1.4-1.3,2.6-2.9,2.6H3.9C2.3,17,1,15.8,1,14.4V3.6 C1,2.2,2.3,1,3.9,1z M3,0C1.3,0,0,1.3,0,3v12c0,1.7,1.3,3,3,3h42c1.7,0,3-1.3,3-3V3c0-1.7-1.3-3-3-3H3z'/></g></svg>","controller":"function PbButtonCtrl($scope, $http, $location, $log, $window) {\r\n\r\n    'use strict';\r\n  \r\n   var vm = this;\r\n   //var hosting = $scope.$location.hostname;\r\n   var hosting = $location.absUrl();\r\n   var port = $location.port; \r\n   var processHost = ''; \r\n   var redirectTo= '';\r\n   var bandera=false;\r\n   console.log(\"/////////localhost//////////////\");\r\n   console.log(hosting);\r\n   if(hosting.includes(\"ccr.igrupobbva\")){\r\n      processHost = '/CRM_CNMC/cnmc_mult_web_portalbonitaweb_01/proxy-aso/proxy-bonita/V01/';\r\n      redirectTo = '/CRM_CNMC/cnmc_mult_web_portalbonitaweb_01';\r\n   }else if(hosting.includes( \"bbvabonita\")){\r\n      processHost = '..';\r\n      redirectTo = '/bonita'; \r\n      bandera=true; \r\n   }else if( port == 8088){\r\n      processHost = '/CRM_CNMC/cnmc_mult_web_pub/proxy-aso/proxy-bonita/V01/';\r\n      redirectTo = '/CRM_CNMC/cnmc_mult_web_pub'; \r\n   }else {\r\n      processHost = '..';\r\n      redirectTo = '/bonita';\r\n      bandera=true; \r\n   }\r\n  \r\n   \r\n    this.action = function action() {\r\n      var id;\r\n    if($scope.properties.secondAction){\r\n      if ($scope.properties.action === 'Start process') {\r\n        id = getUrlParam('id');\r\n        if (id) {\r\n            if(bandera===true){\r\n                doRequest('POST', processHost + '/API/bpm/process/' + id + '/instantiation');\r\n            }else{\r\n                doRequest('POST', processHost + '/API/bpm/process/' + id + '/instantiation?user='+getUrlParam('userId') , getUserParam());\r\n            }\r\n          \r\n        } else {\r\n          $log.log('Impossible to retrieve the process definition id value from the URL');\r\n        }\r\n      } else if ($scope.properties.action === 'Submit task') {\r\n        id = getUrlParam('id');\r\n        if (id) {\r\n            if(bandera===true){\r\n                doRequest('POST', processHost +'/API/bpm/userTask/' + getUrlParam('id') + '/execution');\r\n            }else{\r\n                doRequest('POST', processHost +'/API/bpm/userTask/' + getUrlParam('id') + '/execution?user='+getUrlParam('userId'), getUserParam());\r\n            } \r\n        } else {\r\n          $log.log('Impossible to retrieve the task id value from the URL');\r\n        }\r\n      } else if ($scope.properties.url) {\r\n        doRequest($scope.properties.action, $scope.properties.url);\r\n      }\r\n    }\r\n    };\r\n  \r\n    \r\n    /**\r\n     * Execute a get/post request to an URL\r\n     * It also bind custom data from success|error to a data\r\n     * @return {void}\r\n     */\r\n    function doRequest(method, url, params) {\r\n      vm.busy = true;\r\n      var req = {\r\n        method: method,\r\n        url: url,\r\n        data: angular.copy($scope.properties.dataToSend),\r\n        params: params\r\n      };\r\n  \r\n     return $http(req)\r\n        .success(function(data, status) {\r\n          $scope.properties.dataFromSuccess = data;\r\n          notifyParentFrame({ message: 'success', status: status, dataFromSuccess: data });\r\n          if ($scope.properties.targetUrlOnSuccess && method !== 'GET') {\r\n            //$window.top.location.href($scope.properties.targetUrlOnSuccess);\r\n            $window.top.location.href = redirectTo;\r\n            \r\n          }\r\n        })\r\n        .error(function(data, status) {\r\n          $scope.properties.dataFromError = data;\r\n          notifyParentFrame({ message: 'error', status: status, dataFromError: data  });\r\n        })\r\n        .finally(function() {\r\n          vm.busy = false;\r\n        });\r\n    }\r\n  \r\n    function notifyParentFrame(additionalProperties) {\r\n      if ($window.parent !== $window.self) {\r\n        var dataToSend = angular.extend({}, $scope.properties, additionalProperties);\r\n        $window.parent.postMessage(JSON.stringify(dataToSend), '*');\r\n      }\r\n    }\r\n  \r\n    function getUserParam() {\r\n      var userId = getUrlParam('user');\r\n      if (userId) {\r\n        return { 'user': userId };\r\n      }\r\n      return {};\r\n    }\r\n  \r\n    /**\r\n     * Extract the param value from a URL query\r\n     * e.g. if param = \"id\", it extracts the id value in the following cases:\r\n     *  1. http://localhost/bonita/portal/resource/process/ProcName/1.0/content/?id=8880000\r\n     *  2. http://localhost/bonita/portal/resource/process/ProcName/1.0/content/?param=value&id=8880000&locale=en\r\n     *  3. http://localhost/bonita/portal/resource/process/ProcName/1.0/content/?param=value&id=8880000&locale=en#hash=value\r\n     * @returns {id}\r\n     */\r\n    function getUrlParam(param) {\r\n      var paramValue = $location.absUrl().match('[//?&]' + param + '=([^&#]*)($|[&#])');\r\n      if (paramValue) {\r\n        return paramValue[1];\r\n      }\r\n      return '';\r\n    }\r\n  }\r\n  ","description":"Trigger for an action in a page or form","custom":true,"order":10,"properties":[{"label":"Disabled","name":"disabled","type":"boolean","defaultValue":false,"bond":"expression"},{"label":"Label","name":"label","type":"text","defaultValue":"Submit","bond":"interpolation"},{"label":"Alignment","name":"alignment","type":"choice","defaultValue":"left","choiceValues":["left","center","right"],"bond":"constant"},{"label":"Style","name":"buttonStyle","type":"choice","defaultValue":"default","choiceValues":["default","primary","success","info","warning","danger","link"],"bond":"constant"},{"label":"Action","name":"action","type":"choice","defaultValue":"Submit task","choiceValues":[{"value":"Submit task","label":"Submit task","group":"Bonita BPM"},{"value":"Start process","label":"Start process","group":"Bonita BPM"}],"bond":"constant"},{"label":"URL to call","name":"url","caption":"Send data to this URL when the button is clicked","help":"URL used to perform the HTTP request when this button is clicked.","showFor":"['POST', 'PUT', 'GET', 'DELETE'].indexOf(properties.action.value) > -1","type":"text","bond":"interpolation"},{"label":"Data sent on click","name":"dataToSend","help":"Can be used to fulfill a contract","showFor":"properties.action.value === 'POST' || properties.action.value === 'PUT' || properties.action.value === 'Submit task' || properties.action.value ===  'Start process'","type":"text","bond":"expression"},{"label":"Successful response value","name":"dataFromSuccess","help":"Holds the response when the request is successful","showFor":"['POST', 'PUT', 'GET', 'DELETE', 'Submit task', 'Start process'].indexOf(properties.action.value) > -1","type":"text","bond":"variable"},{"label":"Failed response value","name":"dataFromError","help":"Holds the response when the request has failed","showFor":"['POST', 'PUT', 'GET', 'DELETE', 'Submit task', 'Start process'].indexOf(properties.action.value) > -1","type":"text","bond":"variable"},{"label":"Target URL on success","name":"targetUrlOnSuccess","help":"Next page to display, for applications. In the Portal, it is ignored as navigation is managed automatically","showFor":"['POST', 'PUT', 'DELETE', 'Submit task', 'Start process'].indexOf(properties.action.value) > -1","type":"text","bond":"interpolation"},{"label":"secondAction","name":"secondAction","type":"text","bond":"expression"}],"assets":[],"type":"widget"}
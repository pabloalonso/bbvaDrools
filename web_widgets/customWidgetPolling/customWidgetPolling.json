{"designerVersion":"1.4.34","id":"customWidgetPolling","name":"WidgetPolling","lastUpdate":1531857296609,"template":"<button type=\"button\" class=\"btn btn-primary btn-lg\" ng-click=\"init()\">{{properties.label}}</button>\n\n<!-- Modal -->\n<div class=\"modal fade\" id=\"modalPolling_{{properties.taskId}}\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"{{properties.label}}\">\n    <div class=\"modal-dialog\" role=\"document\">\n        <div class=\"modal-content\">\n            <div class=\"modal-header\">\n                <h4 class=\"modal-title\" id=\"myModalLabel\">{{modalTitle}}</h4>\n            </div>\n            <div class=\"modal-body\">\n                {{modalMessage}}\n            </div>\n        </div>\n    </div>\n</div>","controller":"\nfunction ($scope, $http, $timeout) {\n    \n    $scope.init = function() {\n        \n        $scope.openModal(\"Informaci√≥n\", \"Ejecutando...\");\n        \n        // Properties\n        var taskId = $scope.properties.taskId;\n        \n        var flowName = encodeURI($scope.properties.flowName);\n        \n        var flowVersion = $scope.properties.flowVersion; \n        \n        var processId = $scope.properties.processId;\n        \n        var baseUrl = $scope.properties.baseUrl;\n        \n        // Urls\n        $scope.instantiationUrl = baseUrl + \"/bonita/portal/resource/process/\" + flowName + \"/\" + flowVersion + \"/API/bpm/process/\" + processId + \"/instantiation\";\n        \n        $scope.checkStatusReadyUrl = baseUrl + \"/bonita/API/bdm/businessData/com.bbva.model.AutomaticProcessTask?q=findByStatusAndTaskId&p=0&c=10&f=taskId=\" + taskId + \"&f=flowName=\" + flowName + \"&f=status=READY\";\n        \n        $scope.checkStatusFinishedUrl = baseUrl + \"/bonita/API/bdm/businessData/com.bbva.model.AutomaticProcessTask?q=findByStatusAndTaskId&p=0&c=10&f=taskId=\" + taskId + \"&f=flowName=\" + flowName + \"&f=status=FINISHED\";\n        \n        // Start verifying status\n        $scope.checkStatusReady();  \n    };\n    \n    $scope.checkStatusReady = function() {\n        $http.get($scope.checkStatusReadyUrl).then(function(result) {\n            if(!result.data || !result.data[0]) {\n                if(!$scope.instantiated) {\n                    $scope.instantiate();   \n                } else {\n                    $timeout(function() {\n                        $scope.checkStatusReady();\n                    }, $scope.properties.pollingInterval);\n                }\n            } else {\n                $scope.checkStatusFinished();\n            }\n        }).catch(function(err) {\n            $scope.openModal(\"Error\", \"Error verificando el estado\");\n        });\n    };\n    \n    $scope.checkStatusFinished = function() {\n        $http.get($scope.checkStatusFinishedUrl).then(function(result) {\n                \n            if(!result.data || !result.data[0]) {\n                $timeout(function() {\n                    $scope.checkStatusFinished();\n                }, $scope.properties.pollingInterval);    \n            } else {\n                $scope.properties.output = result.data[0];\n                $scope.instantiated = false;\n                $scope.hideModal();\n            }\n        }).catch(function(err) {\n            $scope.openModal(\"Error\", \"Error verificando el estado\");\n        });\n    }\n    \n    $scope.instantiate = function() {\n        $http({\turl: $scope.instantiationUrl,\n\t\t\t\tmethod: \"POST\",\n\t\t\t\tdata:$scope.properties.dataToSend \n\t\t\t\t})\n\t\t\t.then(function(result) {\n            $scope.instantiated = true;\n            $scope.checkStatusReady();        \n        }).catch(function(err) {\n            $scope.openModal(\"Error\", \"Error instanciando el proceso\");\n        });\n    };\n    \n    $scope.openModal = function(title, message) {\n        $scope.modalTitle = title;\n        $scope.modalMessage = message;\n        \n        $('#modalPolling_' + $scope.properties.taskId).modal({\n            keyboard: false,\n            backdrop: 'static'\n        });  \n    };\n    \n    $scope.hideModal = function() {\n        $('#modalPolling_' + $scope.properties.taskId).modal(\"hide\");\n    };\n    \n}","custom":true,"properties":[{"label":"ID Tarea","name":"taskId","type":"text","bond":"expression"},{"label":"Nombre flow","name":"flowName","type":"text","bond":"expression"},{"label":"Version flow","name":"flowVersion","type":"text","bond":"expression"},{"label":"ID Proceso","name":"processId","type":"text","bond":"expression"},{"label":"URL Base","name":"baseUrl","type":"text","bond":"expression"},{"label":"Datos salida","name":"output","type":"text","bond":"variable"},{"label":"Etiqueta","name":"label","type":"text","bond":"expression"},{"label":"Intervalo reintentos","name":"pollingInterval","help":"Tiempo en milisegundos para reintentar el llamado","type":"text","defaultValue":"3000","bond":"expression"},{"label":"dataToSend","name":"dataToSend","caption":"dataToSend","help":"dataToSend","type":"text","bond":"variable"}],"assets":[{"id":"08202314-1373-4349-9991-a05296c2fc40","name":"bootstrap.min.js","type":"js","order":3,"external":false},{"id":"ce6f36ea-316c-45a5-bcdb-324a0402ecbd","name":"bootstrap.min.css","type":"css","order":1,"external":false},{"id":"31b5edf4-9459-4944-8408-076ff53ade5a","name":"jquery-3.3.1.min.js","type":"js","order":2,"external":false}],"type":"widget"}
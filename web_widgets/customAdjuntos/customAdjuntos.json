{"designerVersion":"1.2.19","id":"customAdjuntos","name":"Adjuntos","lastUpdate":1525454038844,"template":"<div>\r\n    <label class=\"control-label\">{{properties.label}}</label>    \r\n    <span class=\"required\" ng-if=\"properties.required\">*</span>\r\n</div>\r\n\r\n<div class=\"files-container\" ng-if=\"properties.filesQuantity == 1 && !isMobile()\">\r\n    \r\n    <div class=\"input-group\" ng-if=\"properties.readOnly\">\r\n        <input type=\"text\" class=\"form-control\" readonly ng-value=\"preloadedFiles[0].fileOriginalName\">\r\n        \r\n        <span class=\"input-group-addon attach-cyan\" ng-if=\"fileCanView(preloadedFiles[0])\" ng-click=\"view(preloadedFiles[0])\"><span class=\"glyphicon glyphicon-eye-open\"></span></span>\r\n        <span class=\"input-group-addon attach-green\" ng-click=\"download(preloadedFiles[0])\"><span class=\"glyphicon glyphicon-download\"></span></span>\r\n    </div>\r\n    \r\n    <div class=\"input-group\" ng-if=\"!properties.readOnly\">\r\n        <input type=\"text\" class=\"form-control\" readonly ng-value=\"selectedFiles[0].name\">\r\n        <span class=\"input-group-addon attach-blue\" ng-if=\"!selectedFiles[0]\" ngf-select=\"selectFiles($files, $invalidFiles)\" accept=\"{{properties.accept}}\" ngf-max-size=\"{{properties.maxSize}}MB\">\r\n            <span class=\"glyphicon glyphicon-paperclip\"></span>\r\n        </span>\r\n        \r\n        <span class=\"input-group-addon\" ng-if=\"selectedFiles[0].progress && selectedFiles[0].progress < 100\">{{selectedFiles[0].progress}}%</span>\r\n        <span class=\"input-group-addon attach-blue\" ng-click=\"upload(selectedFiles[0])\" ng-disabled=\"selectedFiles[0].uploading\" ng-if=\"selectedFiles[0] && !selectedFiles[0].progress\" ><span class=\"glyphicon glyphicon-upload\"></span></span>\r\n        <span class=\"input-group-addon attach-cyan\" ng-click=\"view(selectedFiles[0])\" ng-if=\"selectedFiles[0].progress == 100\"><span class=\"glyphicon glyphicon-eye-open\"></span></span>\r\n        <span class=\"input-group-addon attach-green\" ng-click=\"download(selectedFiles[0])\" ng-if=\"selectedFiles[0].progress == 100\"><span class=\"glyphicon glyphicon-download\"></span></span>\r\n        <span class=\"input-group-addon attach-yellow\" ng-click=\"abort(selectedFiles[0])\" ng-if=\"selectedFiles[0].progress > 0 && selectedFiles[0].progress < 100\"><span class=\"glyphicon glyphicon-ban-circle\"></span></span>\r\n        <span class=\"input-group-addon attach-red\" ng-click=\"remove(selectedFiles[0])\" ng-if=\"selectedFiles[0] && (!selectedFiles[0].progress || selectedFiles[0].progress == 100)\"><span class=\"glyphicon glyphicon-remove\"></span></span>\r\n    </div>\r\n</div>\r\n\r\n<!--\r\n<div class=\"files-container\" ng-if=\"properties.filesQuantity > 1 && !isMobile()\">\r\n-->\r\n<div class=\"files-container\" ng-if=\"preloadedFiles.length > 0 && !isMobile()\">\r\n    \r\n    <!-- Archivos precargados -->\r\n    <div class=\"files-list\" ng-if=\"preloadedFiles.length > 0\">\r\n        <div class=\"file-item\" ng-repeat=\"f in preloadedFiles\">\r\n            <div class=\"detail row\">\r\n                <div class=\"description col-md-12\">\r\n                    <div class=\"name\">{{f.fileOriginalName}}</div> \r\n                </div>\r\n            </div>\r\n            <div class=\"detail row\">\r\n                <div class=\"description col-md-5\">\r\n                    <div class=\"autor\">Creado por: {{f.createdBy}} el dia {{f.createdDate | date : 'dd-MM-yyyy HH:mm:ss'}}</div>\r\n                    <div class=\"metadata\">Tamaño: {{getFileSize(f)}}</div>\r\n                </div>\r\n                <div class=\"description col-md-5\">\r\n                    <div class=\"metadata\" ng-show=\"f.processName\">Proceso: {{f.processName}} {{f.processVersion}}</div>\r\n                    <div class=\"metadata\" ng-show=\"!f.processName\">Proceso: No seteado</div>\r\n                    \r\n                    <div class=\"metadata\" ng-show=\"f.caseId\">Caso: #{{f.caseId}}</div>\r\n                    <div class=\"metadata\" ng-show=\"!f.caseId\">Caso: No seteado</div>\r\n                    \r\n                    <div class=\"metadata\" ng-show=\"f.activityName\">Actividad: {{f.activityName}}<span ng-show=\"f.activityId\"> (#{{f.activityId}})</span></div>\r\n                    <div class=\"metadata\" ng-show=\"!f.activityName\">Actividad: No seteada</div>\r\n                </div>\r\n                <div class=\"actions col-md-2 text-right\">   \r\n                    <button type=\"button\" class=\"btn btn-info\" ng-if=\"fileCanView(f)\" ng-click=\"view(f)\"><span class=\"glyphicon glyphicon-eye-open\"></span></button>\r\n                    <button type=\"button\" class=\"btn btn-success\" ng-click=\"download(f)\"><span class=\"glyphicon glyphicon-download\"></span></button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    \r\n    <!-- Archivos nuevos -->\r\n    <div class=\"global-actions\" ng-if=\"!properties.readOnly\">\r\n        <button type=\"button\" class=\"btn btn-success\" ngf-select=\"selectFiles($files, $invalidFiles)\" multiple accept=\"{{properties.accept}}\" ngf-max-size=\"{{properties.maxSize}}MB\"><span class=\"glyphicon glyphicon-plus\"></span> Agregar</button>\r\n    </div>\r\n    \r\n    <div class=\"files-list\" style=\"margin-top: 10px;\" ng-if=\"selectedFiles.length > 0 && !properties.readOnly\">\r\n        <div class=\"file-item\" ng-repeat=\"f in selectedFiles\">\r\n            <div class=\"detail row\">\r\n                <div class=\"description col-md-10\">\r\n                    <div class=\"name\">{{f.fileName ? f.fileName : f.name}}</div> \r\n                    <div class=\"autor\">Creado por: {{properties.createdBy}}</div>\r\n                    <div class=\"size\">Tamaño: {{getFileSize(f)}}</div>\r\n                </div>\r\n                <div class=\"actions col-md-2 text-right\">\r\n                    <button type=\"button\" class=\"btn btn-primary\" ng-click=\"upload(f)\" ng-disabled=\"f.uploading\" ng-if=\"!f.progress || f.progress < 100\"><span class=\"glyphicon glyphicon-upload\"></span></button>\r\n                    \r\n                    <button type=\"button\" class=\"btn btn-info\" ng-click=\"view(f)\" ng-if=\"f.progress == 100 && fileCanView(f)\"><span class=\"glyphicon glyphicon-eye-open\"></span></button>\r\n                    <button type=\"button\" class=\"btn btn-success\" ng-click=\"download(f)\" ng-if=\"f.progress == 100\"><span class=\"glyphicon glyphicon-download\"></span></button>\r\n                    <button type=\"button\" class=\"btn btn-warning\" ng-click=\"abort(f)\" ng-if=\"f.progress > 0 && f.progress < 100\"><span class=\"glyphicon glyphicon-ban-circle\"></span></button>            \r\n                    <button type=\"button\" class=\"btn btn-danger\" ng-click=\"remove(f)\"><span class=\"glyphicon glyphicon-remove\"></span></button>            \r\n                </div>\r\n            </div>\r\n            \r\n            <div class=\"progress\" ng-show=\"f.progress >= 0\">\r\n                <div style=\"width:{{f.progress}}%\" ng-bind=\"f.progress + '%'\"></div>\r\n            </div>\r\n        </div>\r\n    </div>    \r\n</div>\r\n\r\n<!-- Mobile -->\r\n<div class=\"files-container\" ng-if=\"isMobile()\">\r\n    <!-- generated PDF -->\r\n    <div class=\"input-group\">\r\n        <input type=\"text\" class=\"form-control\" readonly ng-value=\"preloadedFiles[0].fileOriginalName\">\r\n        <span class=\"input-group-addon attach-green\"    \r\n            ng-if=\"!mobileState.converted\" \r\n            ng-disabled=\"mobileState.converting\" \r\n            ngf-select=\"selectFiles($files, $invalidFiles)\" \r\n            multiple accept=\"{{properties.accept}}\" \r\n            ngf-max-size=\"{{properties.maxSize}}MB\"\r\n            >\r\n            <span class=\"glyphicon glyphicon-plus\"></span>\r\n        </span>\r\n        <span class=\"input-group-addon attach-blue\"     ng-click=\"uploadMobile()\" ng-if=\"mobileState.maxSize && selectedFiles.length > 0 && !(mobileState.uploading || mobileState.progress == 100)\"><span class=\"glyphicon glyphicon-upload\"></span></span>\r\n        <span class=\"input-group-addon attach-yellow\"   ng-click=\"abortMobile()\" ng-if=\"mobileState.progress > 0 && mobileState.progress < 100\" ><span class=\"glyphicon glyphicon-ban-circle\"></span></span>\r\n        \r\n        <span class=\"input-group-addon attach-cyan\"     ng-click=\"view(preloadedFiles[0])\" ng-if=\"mobileState.converted && fileCanView(preloadedFiles[0])\"><span class=\"glyphicon glyphicon-eye-open\"></span></span>\r\n        <!--\r\n        <span class=\"input-group-addon attach-green\"    ng-click=\"download(preloadedFiles[0])\" ng-if=\"mobileState.converted\"><span class=\"glyphicon glyphicon-download\"></span></span>\r\n        -->\r\n        <span class=\"input-group-addon attach-red\"      ng-click=\"removeImagesMobile()\" ng-if=\"mobileState.converted\"><span class=\"glyphicon glyphicon-remove\"></span></span>\r\n    </div>\r\n    \r\n    <div class=\"alert alert-danger\" ng-if=\"!mobileState.maxSize\">\r\n        Supera tamaño máximo {{properties.maxSize}} MB\r\n    </div>\r\n    \r\n    <!-- progress -->\r\n    <div class=\"progress\" ng-show=\"mobileState.progress == 100 && !mobileState.converted\">\r\n        <div class=\"progress-bar progress-bar-striped\" style=\"width:100%\" >Procesando adjuntos</div>\r\n    </div>\r\n    <div class=\"progress\" ng-show=\"mobileState.progress > 0 && mobileState.progress < 100\">\r\n        <div class=\"progress-bar progress-bar-striped\" style=\"width:{{mobileState.progress}}%\" ng-bind=\"mobileState.progress + '%'\"></div>\r\n    </div>\r\n\r\n    <!-- file list -->\r\n    <div class=\"files-list\" style=\"margin-top: 10px;\" ng-if=\"selectedFiles.length > 0 && !properties.readOnly\">\r\n        <div class=\"file-item\" ng-repeat=\"f in selectedFiles\">\r\n            <div class=\"detail row\">\r\n                <div class=\"description col-sm-10\">\r\n                    <div class=\"name\">{{f.fileName ? f.fileName : f.name}}</div>\r\n                    <div class=\"size\">Tamaño: {{getFileSize(f)}}</div>\r\n                </div>\r\n                <div class=\"actions col-sm-2 text-right\">\r\n                    <button type=\"button\" class=\"btn btn-danger\" ng-click=\"removeImageFromList(f)\" ng-if=\"!mobileState.uploading && mobileState.progress != 100\">\r\n                        <span class=\"glyphicon glyphicon-remove\"></span>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<div class=\"required\" ng-if=\"properties.required && !valid && dirty\">El documento es obligatorio</div>\r\n<input type=\"hidden\" ng-required=\"properties.required\" ng-model=\"valid\">","controller":"\r\nfunction ($scope, $filter, $timeout, $location, $http, Upload, widgetNameFactory) {\r\n    \r\n    this.name = widgetNameFactory.getName('customAdjuntos');\r\n    \r\n    $scope.$watch(\"properties.targetUrl\", function(newValue, oldValue) {\r\n        $scope.preloadFiles();\r\n    });\r\n    \r\n    $scope.$watch(\"properties.preloadIds\", function(newValue, oldValue) {\r\n        $scope.preloadFiles();\r\n    });\r\n    \r\n    $scope.$watch(\"properties.taskId\", function(newValue, oldValue) {\r\n        $scope.init();\r\n    });\r\n    \r\n    $scope.init = function() {\r\n        // Inicializo los selectedFiles\r\n\t\tif(!$scope.selectedFiles) {\t\t\t\r\n\t\t\t$scope.selectedFiles = []\r\n\t\t}\r\n\t\t\r\n        if($scope.properties.taskId) {\r\n            $http.get('../API/bpm/task/' + $scope.properties.taskId).then(function(response) {\r\n                if(response.data) {\r\n                    $scope.caseId = response.data.caseId;\r\n                    $scope.activityName = response.data.name;\r\n                    \r\n                    $http.get('../API/bpm/process/' + response.data.processId).then(function(response) {   \r\n                        if(response.data) {\r\n                            $scope.processName = response.data.name;\r\n                            $scope.processVersion = response.data.version;\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n        \r\n        // Cargo archivos que ya esten agregados\r\n\t\tif($scope.properties.selectedFiles) {\t\t\t\r\n\t\t\t$http.get($scope.properties.targetUrl + '/findByIds?ids=' + $scope.getIdsString($scope.properties.selectedFiles)).then(function(result) {\r\n\t\t\t\tif(result.data) {\r\n\t\t\t\t    if($scope.isMobile()){\r\n                        $scope.mobileState.id = result.data;\r\n                        $scope.mobileState.converted = true;\r\n                        $scope.mobileState.uploading = false;\r\n                        $scope.mobileState.progress = 100;\r\n\t\t\t\t        \r\n\t\t\t\t        $scope.preloadedFiles = result.data;\r\n\t\t\t\t    } else {\r\n\t\t\t\t        for(var i = 0; i <= result.data.length; i++) {\r\n\t\t\t\t\t\tvar f = result.data[i];\r\n\t\t\t\t\t\tf.name = f.fileOriginalName;\r\n\t\t\t\t\t\tf.progress = 100;\r\n\t\t\t\t\t\t$scope.selectedFiles.push(f);\r\n\t\t\t\t\t}\r\n\t\t\t\t    }\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n    }\r\n    \r\n    //tipo dispositivo\r\n    var vIsMobile = {\r\n    \tAndroid: function() {return navigator.userAgent.match(/Android/i);},\r\n    \tBlackBerry: function() {return navigator.userAgent.match(/BlackBerry/i);},\r\n    \tiOS: function() {return navigator.userAgent.match(/iPhone|iPad|iPod/i);},\r\n    \tOpera: function() {return navigator.userAgent.match(/Opera Mini/i);},\r\n    \tWindows: function() {return navigator.userAgent.match(/IEMobile/i);},\r\n    \tany: function() {return (vIsMobile.Android() || vIsMobile.BlackBerry() || vIsMobile.iOS() || vIsMobile.Opera() || vIsMobile.Windows());}\r\n    };\r\n    \r\n    $scope.isMobile = function() {\r\n        if(vIsMobile.any() == undefined){\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n    \r\n    // Seleccionar los archivos\r\n    $scope.selectFiles = function(files, errFiles) {\r\n        \r\n        if(files.length == 0){\r\n            return;\r\n        }\r\n        \r\n        if(!$scope.selectedFiles) {\r\n            $scope.selectedFiles = new Array();\r\n        }\r\n        \r\n        // validar limite de archivos a subir, y que no este en movil\r\n        if($scope.properties.filesQuantity && !$scope.isMobile()) {\r\n            if($scope.properties.filesQuantity < (files.length + $scope.selectedFiles.length)) {\r\n                alert(\"Solo puede seleccionar hasta \" + $scope.properties.filesQuantity + \" archivos\");\r\n                return false;\r\n            }\r\n        }\r\n        \r\n        // ---validar dispositivo solo imagenes\r\n        if($scope.isMobile()){\r\n            var errMsj = null;\r\n            //\r\n            if(files.length > 1 || $scope.selectedFiles.length > 0){\r\n                for(var i = 0; i < files.length; i++) {\r\n                    if(!files[i].type.startsWith(\"image\")){\r\n    \t\t\t\t\tisValid = false;\r\n    \t\t\t\t\terrMsj = \"Solo puede seleccionar 1 archivo o multiples imagenes.\";\r\n    \t\t\t\t}\r\n                }\r\n            }\r\n            \r\n            // si hay uno, y no es imagen\r\n            if($scope.selectedFiles.length == 1){\r\n                if(!$scope.selectedFiles[0].type.startsWith(\"image\")){\r\n                    isValid = false;\r\n                    errMsj = \"Solo se permite 1 archivo diferente de imágen\";\r\n                }\r\n                \r\n            }\r\n            \r\n            $scope.checkMaxSizeMobile(files);\r\n            \r\n            if(errMsj != null){\r\n                alert(errMsj);\r\n                return false;\r\n            }\r\n        }\r\n        \r\n        for(var i = 0; i < files.length; i++) {\r\n            $scope.selectedFiles.push(files[i]);    \r\n        }\r\n        \r\n        if(errFiles && errFiles.length > 0 && !isMobile()) {\r\n            var errString = \"\";\r\n            for(var i = 0; i < errFiles.length; i++) {\r\n                if(errFiles[i].$errorMessages.maxSize) {\r\n                    if(errString.length > 0) {\r\n                        errString += \"\\n\";\r\n                    }\r\n                    errString += \" - El archivo \" + errFiles[i].name + \" supera el tamaño permitido de \" + errFiles[i].$errorParam\r\n                }\r\n            }\r\n            \r\n            if(errString.length > 0) {\r\n                alert(errString);\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Recupera los archivos del caso\r\n    $scope.preloadFiles = function() {\r\n        if($scope.properties.targetUrl && $scope.properties.preloadIds && $scope.properties.preloadIds.length > 0) {\r\n            $http.get($scope.properties.targetUrl + \"/findByIds?ids=\" + $scope.getIdsString($scope.properties.preloadIds)).then(function(response) {\r\n                var docs = \tresponse.data;\r\n\t\t\t\tdocs.sort(function(a, b) {\r\n\t\t\t\t\treturn parseFloat(a.id) - parseFloat(b.id);\r\n\t\t\t\t});\t\t\t\t\r\n                $scope.preloadedFiles = docs;\r\n            \r\n                //$scope.preloadedFiles = response.data;\r\n                \r\n                if($scope.isMobile()){\r\n                    $scope.mobileState.id = response.data.id;\r\n                    $scope.mobileState.converted = true;\r\n                }\r\n                \r\n            }, function() {\r\n                //alert(\"Error recuperando los archivos\");\r\n            });\r\n        }\r\n    }\r\n    \r\n    $scope.getIdsString = function(idsArray) {\r\n        var idsString = \"\";\r\n        \r\n        for(var i = 0; i< idsArray.length; i++) {\r\n            if(idsString.length > 0) {\r\n                idsString += \",\";\r\n            }\r\n            \r\n            idsString += idsArray[i];\r\n        }\r\n        \r\n        return idsString;\r\n    }\r\n    \r\n    // Subir un archivo\r\n    $scope.upload = function(file) {\r\n        \r\n        // Marco el archivo como en estado subiendo\r\n        file.uploading = true;\r\n        \r\n        if($scope.properties.taskId) {\r\n            file.upload = Upload.upload({\r\n                url: $scope.properties.targetUrl + \"/uploadDocument\",\r\n                data: {\r\n                    processName: $scope.processName,\r\n                    processVersion: $scope.processVersion,\r\n                    caseId: $scope.caseId,\r\n                    activityName: $scope.activityName,\r\n                    activityId: $scope.properties.taskId,\r\n                    createdBy: $scope.properties.createdBy,\r\n                    identification: $scope.properties.identification,\r\n                    businessCaseId: $scope.properties.businessCaseId,\r\n                    type: $scope.properties.type,\r\n                    file: file\r\n                }\r\n            });    \r\n        } else {\r\n            file.upload = Upload.upload({\r\n                url: $scope.properties.targetUrl + \"/uploadDocument\",\r\n                data: {\r\n                    createdBy: $scope.properties.createdBy,\r\n                    identification: $scope.properties.identification,\r\n                    businessCaseId: $scope.properties.businessCaseId,\r\n                    type: $scope.properties.type,\r\n                    file: file\r\n                }\r\n            });\r\n        }\r\n        \r\n        file.upload.then(function (response) {\r\n            // Marco el archivo como que termino de subir\r\n            file.uploading = false;\r\n        \r\n            if(!$scope.properties.selectedFiles) {\r\n                $scope.properties.selectedFiles = new Array();\r\n            }\r\n            \r\n            $scope.properties.selectedFiles.push(response.data);\r\n            file.id = response.data;   \r\n            \r\n            $scope.valid = true;\r\n            $scope.dirty = true;\r\n        }, function (response) {\r\n            // Marco el archivo como que termino de subir\r\n            file.uploading = false;\r\n            \r\n            if (response.status > 0) {\r\n                $scope.errorMsg = response.status + ': ' + response.data;\r\n            } else {\r\n                $scope.errorMsg = \"Error inesperado, contacte al administrador.\";\r\n            }\r\n            \r\n            alert($scope.errorMsg);\r\n            \r\n        }, function (evt) {\r\n            // Marco el archivo como que termino de subir\r\n            file.uploading = false;\r\n            \r\n            file.progress = Math.min(100, parseInt(100.0 * evt.loaded / evt.total));\r\n        });\r\n    }\r\n    \r\n    $scope.mobileState = { \r\n        uploading : false,\r\n        progress : 0,\r\n        id: null,\r\n        converted : false,\r\n        converting : false,\r\n        maxSize : true\r\n    }\r\n\r\n    $scope.uploadMobile = function(){\r\n        $scope.sendMobile($scope.selectedFiles);\r\n    }\r\n    \r\n    $scope.sendMobile = function(file) {\r\n        \r\n        // Marco el archivo como en estado subiendo\r\n        $scope.mobileState.uploading = true;\r\n        $scope.mobileState.progress = 0;\r\n        $scope.mobileState.converted = false;\r\n        $scope.mobileState.converting = true;\r\n        \r\n        if($scope.properties.taskId) {\r\n            file.upload = Upload.upload({\r\n                url: $scope.properties.targetUrl + \"/uploadDocumentMobile\",\r\n                data: {\r\n                    processName: $scope.processName,\r\n                    processVersion: $scope.processVersion,\r\n                    caseId: $scope.caseId,\r\n                    activityName: $scope.activityName,\r\n                    activityId: $scope.properties.taskId,\r\n                    createdBy: $scope.properties.createdBy,\r\n                    identification: $scope.properties.identification,\r\n                    businessCaseId: $scope.properties.businessCaseId,\r\n                    type: $scope.properties.type,\r\n                    file: file\r\n                },\r\n                arrayKey: ''\r\n            });    \r\n        } else {\r\n            file.upload = Upload.upload({\r\n                url: $scope.properties.targetUrl + \"/uploadDocumentMobile\",\r\n                data: {\r\n                    createdBy: $scope.properties.createdBy,\r\n                    identification: $scope.properties.identification,\r\n                    businessCaseId: $scope.properties.businessCaseId,\r\n                    type: $scope.properties.type,\r\n                    file: file\r\n                },\r\n                arrayKey: ''\r\n            });\r\n        }\r\n        \r\n        file.upload.then(function (response) {\r\n            // Marco el archivo como que termino de subir\r\n            $scope.mobileState.uploading = false;\r\n        \r\n            if(!$scope.properties.selectedFiles) {\r\n                $scope.properties.selectedFiles = new Array();\r\n            }\r\n            \r\n            $scope.properties.selectedFiles.push(response.data);\r\n            $scope.mobileState.id = response.data;\r\n            $scope.mobileState.converted = true;\r\n            \r\n            // get file info\r\n            $http.get($scope.properties.targetUrl + \"/findByIds?ids=\" + response.data).then(function(response) {\r\n                $scope.preloadedFiles = response.data;\r\n                $scope.selectedFiles = new Array();\r\n            }, function() {\r\n                //alert(\"Error recuperando los archivos\");\r\n            });\r\n            \r\n            $scope.valid = true;\r\n            $scope.dirty = true;\r\n        }, function (response) {\r\n            // Marco el archivo como que termino de subir\r\n            $scope.mobileState.uploading = false;\r\n            \r\n            if (response.status > 0) {\r\n                $scope.errorMsg = response.status + ': ' + response.data;\r\n            } else {\r\n                $scope.errorMsg = \"Error inesperado, contacte al administrador.\";\r\n            }\r\n            alert($scope.errorMsg);\r\n            \r\n        }, function (evt) {\r\n            // Marco el archivo como que termino de subir\r\n            $scope.mobileState.progress = Math.min(100, parseInt(100.0 * evt.loaded / evt.total));\r\n            \r\n        });\r\n    }\r\n    \r\n    $scope.abortMobile = function(){\r\n        $scope.selectedFiles.upload.abort();\r\n    }\r\n    \r\n    $scope.checkMaxSizeMobile = function(files){\r\n        var isValid = true;\r\n        if($scope.properties.maxSize){\r\n            var totalBytes = 0;\r\n            \r\n            if(files){\r\n                for(var i = 0; i < files.length; i++) {\r\n                    totalBytes += files[i].size;\r\n                }\r\n            }\r\n            \r\n            for(var i = 0; i < $scope.selectedFiles.length; i++) {\r\n                totalBytes += $scope.selectedFiles[i].size;\r\n            }\r\n            \r\n            if(totalBytes > ($scope.properties.maxSize * 1048576 )){\r\n                isValid = false;\r\n            }\r\n        }\r\n        \r\n        $scope.mobileState.maxSize = isValid;\r\n    }\r\n    \r\n    $scope.removeImagesMobile = function() {\r\n        if($scope.preloadedFiles.length > 0){\r\n        \tfor(var i = 0; i < $scope.properties.selectedFiles.length; i++) {\r\n                if($scope.properties.selectedFiles[i] == $scope.preloadedFiles[0].id) {\r\n                    $scope.properties.selectedFiles.splice(i, 1);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        $scope.preloadedFiles = new Array();\r\n        $scope.mobileState.converted = false;\r\n        $scope.mobileState.progress = 0;\r\n        $scope.mobileState.converting = false;\r\n    }\r\n    \r\n    $scope.removeImageFromList = function(file){\r\n        for(var i = 0; i < $scope.selectedFiles.length; i++) {\r\n            \r\n            if($scope.selectedFiles[i].$$hashKey == file.$$hashKey){\r\n                $scope.selectedFiles.splice(i, 1);\r\n                break;\r\n            }\r\n        }\r\n        \r\n        $scope.checkMaxSizeMobile(null);\r\n    }\r\n    \r\n    $scope.fileCanView = function(file) {\r\n        if(file) {\r\n            var fileType = file.fileContentType ? file.fileContentType : file.type;\r\n            \r\n            return fileType.startsWith(\"image\") || \r\n                   fileType == \"application/pdf\" || \r\n                   fileType == \"application/msword\" || \r\n                   fileType == \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\" ||\r\n                   fileType == \"application/vnd.ms-excel\" ||\r\n                   fileType == \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\" ||\r\n                   fileType == \"application/vnd.ms-powerpoint\" ||\r\n                   fileType == \"application/vnd.openxmlformats-officedocument.presentationml.presentation\";\r\n        } else {\r\n            return false;\r\n        }\r\n    }\r\n    \r\n    // Ver el archivo\r\n    $scope.view = function(file) {\r\n        var url = $scope.properties.targetUrl + \"/view/\" + file.id;\r\n        window.open(url, \"_blank\");\r\n    }\r\n    \r\n    // Descargar un archivo\r\n    $scope.download = function(file) {\r\n        var url = $scope.properties.targetUrl + \"/download/\" + file.id;\r\n        window.location = url;\r\n    }\r\n    \r\n    // Aborta la subida de un archivo\r\n    $scope.abort = function(file) {\r\n        file.upload.abort();\r\n    }\r\n    \r\n    $scope.remove = function(file) {\r\n        for(var i = 0; i < $scope.selectedFiles.length; i++) {\r\n            if($scope.selectedFiles[i].id == file.id) {\r\n                $scope.selectedFiles.splice(i, 1);\r\n                $scope.properties.selectedFiles.splice(i, 1);\r\n                break;\r\n            }\r\n        }\r\n        \r\n        if($scope.properties.selectedFiles.length == 0) {\r\n            $scope.valid = null;\r\n        }\r\n    }\r\n    \r\n    // Retorna el tamaño del archivo en la unidad mas legible\r\n    $scope.getFileSize = function(file) {\r\n        if(file && (file.size || file.fileSize)) {\r\n            \r\n            size = (file.fileSize ? file.fileSize : file.size) / 1024; \r\n            unit = \"KB\";\r\n            \r\n            if(size > 1024) { // MB\r\n                size = size / 1024;\r\n                unit = \"MB\";\r\n            }\r\n            \r\n            return $filter(\"number\")(size, 2) + \" \" + unit;\r\n        }\r\n        \r\n        return -1;\r\n    }\r\n}","description":"V2.2 Adjuntos en dispositivos:\nFix 27-12-2017 En la paginación no se pierden los datos\nFix 15-01-2018 Se precargan archivos en desktop, se tiene en cuenta preloadedFiles, no el atributo filesQuantity","custom":true,"properties":[{"label":"URL Destino","name":"targetUrl","type":"text","bond":"expression"},{"label":"Id tarea","name":"taskId","type":"text","bond":"expression"},{"label":"Archivos soportados","name":"accept","type":"text","bond":"expression"},{"label":"Tamaño máximo (MB)","name":"maxSize","type":"integer","bond":"expression"},{"label":"Archivos seleccionados","name":"selectedFiles","type":"text","bond":"variable"},{"label":"Tipo de documento","name":"type","type":"text","bond":"expression"},{"label":"Archivos a precargar (Ids)","name":"preloadIds","type":"collection","bond":"expression"},{"label":"Identificación","name":"identification","type":"text","bond":"expression"},{"label":"Solo lectura","name":"readOnly","type":"boolean","bond":"expression"},{"label":"Cantidad de archivos","name":"filesQuantity","type":"integer","bond":"expression"},{"label":"Etiqueta","name":"label","type":"text","bond":"expression"},{"label":"Requerido","name":"required","type":"boolean","bond":"expression"},{"label":"ID Caso Negocio","name":"businessCaseId","type":"text","bond":"expression"},{"label":"Creado por","name":"createdBy","type":"text","bond":"expression"}],"assets":[{"id":"9bdae5aa-47d6-45ab-9285-b18306c1cd6c","name":"ng-file-upload.min.js","type":"js","order":12,"external":false},{"id":"83a972bd-1d19-49ec-ad2f-4e95fd6c6471","name":"ng-file-upload-shim.min.js","type":"js","order":9,"external":false},{"id":"df43d4dc-65c7-4733-a72e-210cac46e76f","name":"jquery-3.1.1.min.js","type":"js","order":7,"external":false},{"id":"379fc8e3-b978-4050-b82e-86d7f9be82aa","name":"adjuntos-styles.css","type":"css","order":13,"external":false}],"requiredModules":["ngFileUpload"],"type":"widget"}